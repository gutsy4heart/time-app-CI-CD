name: CI/CD for LiteraHouse Project

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üê≥ –õ–æ–≥–∏–Ω –≤ Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ ASP.NET –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/literahouse-api:latest .

      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–∞ –≤ Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/literahouse-api:latest

      - name: üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH –∫–ª—é—á–∞
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üñ•Ô∏è –î–µ–ø–ª–æ–π –Ω–∞ Azure VM –ø–æ SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'EOF'
            echo "üì¶ –°–∫–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞–∑ —Å Docker Hub"
            docker pull ${{ secrets.DOCKER_USERNAME }}/literahouse-api:latest

            echo "üõë –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)"
            docker stop literahouse-container || true
            docker rm literahouse-container || true

            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
            docker run -d --name literahouse-container -p 80:80 ${{ secrets.DOCKER_USERNAME }}/literahouse-api:latest
          EOF
